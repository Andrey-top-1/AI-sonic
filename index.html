<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИИ Сонник - Толкователь снов</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0c0c2b 0%, #1a1a3e 100%);
            --chat-bg: rgba(25, 25, 50, 0.9);
            --user-msg: #4a4a8a;
            --bot-msg: #2d2d5a;
            --accent: #ff6b6b;
            --accent-hover: #ff5252;
            --text-primary: #f1f1f1;
            --text-secondary: #b8b8d6;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            --radius: 18px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Анимация звёзд */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }

        /* Шапка */
        header {
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .logo i {
            font-size: 1.8rem;
            color: #a78bfa;
        }

        .user-menu {
            position: relative;
        }

        .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-icon:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.25);
        }

        .dropdown-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background: rgba(40, 40, 70, 0.95);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 15px 0;
            width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .user-menu:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu button {
            width: 100%;
            padding: 15px 25px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-menu button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-menu i {
            width: 20px;
            text-align: center;
        }

        /* Основной чат */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 95%;
            margin: 0 auto 100px;
            background: var(--chat-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 70vh;
        }

        .chat-header {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(40, 40, 70, 0.8);
        }

        .chat-header h2 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .chat-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 65vh;
            min-height: 400px;
        }

        .message {
            margin-bottom: 1.5rem;
            display: flex;
            animation-duration: 0.5s;
            animation-fill-mode: both;
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 18px;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            line-height: 1.5;
            position: relative;
        }

        .user-message .message-bubble {
            background: var(--user-msg);
            color: white;
            border-bottom-right-radius: 5px;
            animation-name: slideInFromRight;
        }

        .bot-message .message-bubble {
            background: var(--bot-msg);
            color: var(--text-primary);
            border-bottom-left-radius: 5px;
            animation-name: slideInFromLeft;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .bot-message .message-time {
            text-align: left;
        }

        /* Кнопка озвучивания */
        .tts-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .tts-btn:hover {
            opacity: 1;
            color: var(--accent);
        }

        /* Skeleton loader */
        .skeleton {
            display: flex;
            gap: 10px;
        }

        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(90deg, #2d2d5a 25%, #3a3a6a 50%, #2d2d5a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .skeleton-content {
            flex: 1;
        }

        .skeleton-line {
            height: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #2d2d5a 25%, #3a3a6a 50%, #2d2d5a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .skeleton-line.short {
            width: 60%;
        }

        .skeleton-line.medium {
            width: 80%;
        }

        /* Панель ввода */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: rgba(25, 25, 50, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            max-width: 900px;
            margin: 0 auto;
        }

        .text-input {
            flex: 1;
            padding: 14px 18px;
            border: none;
            border-radius: 25px;
            background: rgba(40, 40, 70, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
            transition: all 0.3s ease;
            resize: none;
            max-height: 120px;
            min-height: 50px;
            color: var(--text-primary);
        }

        .text-input:focus {
            outline: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transform: scale(1.02);
            background: rgba(50, 50, 90, 0.9);
        }

        .text-input::placeholder {
            color: var(--text-secondary);
        }

        .text-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.1rem;
        }

        .btn-send {
            background: var(--accent);
        }

        .btn-voice {
            background: var(--user-msg);
        }

        .btn:hover {
            transform: scale(1.1);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--chat-bg);
            border-radius: var(--radius);
            width: 90%;
            max-width: 450px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--accent);
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(40, 40, 70, 0.9);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.2);
        }

        .form-button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 0.5rem;
        }

        .form-button:hover {
            background: var(--accent-hover);
        }

        .form-footer {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
        }

        /* Планы оплаты */
        .plans-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .plan-card {
            background: rgba(40, 40, 70, 0.7);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .plan-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .plan-card.selected {
            border-color: var(--accent);
            background: rgba(255, 107, 107, 0.1);
        }

        .plan-name {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .plan-price {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .plan-features {
            list-style: none;
            margin-bottom: 1.5rem;
        }

        .plan-features li {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        .plan-features i {
            color: var(--accent);
        }

        /* Анимации */
        @keyframes slideInFromRight {
            0% {
                opacity: 0;
                transform: translateX(30px);
            }
            70% {
                transform: translateX(-5px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromLeft {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .chat-container {
                width: 98%;
                margin-bottom: 120px;
            }

            .message-bubble {
                max-width: 85%;
            }

            header {
                padding: 1rem;
            }

            .logo {
                font-size: 1.2rem;
            }
            
            .dropdown-menu {
                width: 200px;
            }
            
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .chat-messages {
                padding: 1rem;
            }

            .input-container {
                padding: 1rem;
            }

            .text-input {
                padding: 12px 16px;
            }

            .btn {
                width: 45px;
                height: 45px;
            }
            
            .dropdown-menu {
                width: 180px;
                padding: 10px 0;
            }
            
            .dropdown-menu button {
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Анимация звёзд -->
    <div class="stars" id="stars"></div>

    <!-- Шапка -->
    <header>
        <div class="logo">
            <i class="fas fa-moon"></i>
            <span>ИИ Сонник</span>
        </div>
        <div class="user-menu">
            <div class="user-icon" id="userIcon">
                <i class="fas fa-user" id="userIconSymbol"></i>
                <span id="userInitials" style="display: none;"></span>
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <button id="phoneLoginBtn"><i class="fas fa-mobile-alt"></i> Войти по телефону</button>
                <button id="paymentBtn"><i class="fas fa-credit-card"></i> Оплатить</button>
                <button id="logoutBtn" style="display: none;"><i class="fas fa-sign-out-alt"></i> Выйти</button>
            </div>
        </div>
    </header>

    <!-- Основной чат -->
    <div class="chat-container">
        <div class="chat-header">
            <h2>ИИ Толкователь снов</h2>
            <p>Опишите свой сон, и я помогу его растолковать</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- Сообщения будут добавляться здесь -->
        </div>
    </div>
    
    <!-- Панель ввода -->
    <div class="input-container">
        <div class="input-wrapper">
            <textarea class="text-input" id="messageInput" placeholder="Опишите свой сон..." rows="1" disabled></textarea>
            <div class="action-buttons">
                <button class="btn btn-voice" id="voiceBtn" aria-label="Голосовой ввод" disabled>
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="btn btn-send" id="sendBtn" aria-label="Отправить сообщение" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно входа по телефону -->
    <div class="modal" id="phoneLoginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Вход по номеру телефона</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="phoneLoginForm">
                <div class="form-group">
                    <label class="form-label" for="userName">Ваше имя</label>
                    <input type="text" class="form-input" id="userName" placeholder="Введите ваше имя" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="userPhone">Номер телефона</label>
                    <input type="tel" class="form-input" id="userPhone" placeholder="+7 (XXX) XXX-XX-XX" required>
                </div>
                <button type="submit" class="form-button">Войти</button>
                <div class="form-footer">
                    Входя в аккаунт, вы соглашаетесь с условиями использования
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно оплаты -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Выберите тариф</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="plans-container">
                <div class="plan-card" data-plan="basic">
                    <div class="plan-name">Базовый</div>
                    <div class="plan-price">299 ₽/мес</div>
                    <ul class="plan-features">
                        <li><i class="fas fa-check"></i> 50 толкований в месяц</li>
                        <li><i class="fas fa-check"></i> Базовая интерпретация снов</li>
                        <li><i class="fas fa-check"></i> Сохранение истории</li>
                    </ul>
                    <button class="form-button" data-plan="basic">Выбрать</button>
                </div>
                <div class="plan-card" data-plan="premium">
                    <div class="plan-name">Премиум</div>
                    <div class="plan-price">799 ₽/мес</div>
                    <ul class="plan-features">
                        <li><i class="fas fa-check"></i> Неограниченные толкования</li>
                        <li><i class="fas fa-check"></i> Расширенный анализ снов</li>
                        <li><i class="fas fa-check"></i> Персональные рекомендации</li>
                        <li><i class="fas fa-check"></i> Приоритетная поддержка</li>
                    </ul>
                    <button class="form-button" data-plan="premium">Выбрать</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const voiceBtn = document.getElementById('voiceBtn');
            const starsContainer = document.getElementById('stars');
            
            // Элементы авторизации
            const userIcon = document.getElementById('userIcon');
            const userIconSymbol = document.getElementById('userIconSymbol');
            const userInitials = document.getElementById('userInitials');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const phoneLoginBtn = document.getElementById('phoneLoginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            
            // Модальные окна
            const phoneLoginModal = document.getElementById('phoneLoginModal');
            const paymentModal = document.getElementById('paymentModal');
            const paymentBtn = document.getElementById('paymentBtn');
            const closeButtons = document.querySelectorAll('.close-modal');
            
            // Создание анимации звёзд
            function createStars() {
                const starsCount = 100;
                
                for (let i = 0; i < starsCount; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    
                    // Случайный размер от 1 до 3 пикселей
                    const size = Math.random() * 2 + 1;
                    star.style.width = `${size}px`;
                    star.style.height = `${size}px`;
                    
                    // Случайная позиция
                    star.style.left = `${Math.random() * 100}vw`;
                    star.style.top = `${Math.random() * 100}vh`;
                    
                    // Случайная длительность анимации от 10 до 30 секунд
                    const duration = Math.random() * 20 + 10;
                    star.style.animationDuration = `${duration}s`;
                    
                    // Случайная задержка анимации
                    star.style.animationDelay = `${Math.random() * 5}s`;
                    
                    starsContainer.appendChild(star);
                }
            }
            
            // Проверка авторизации
            function checkAuth() {
                const userData = JSON.parse(localStorage.getItem('userData'));
                if (userData) {
                    // Пользователь авторизован
                    updateUIForLoggedInUser(userData);
                    return true;
                } else {
                    // Пользователь не авторизован
                    updateUIForGuest();
                    return false;
                }
            }
            
            // Обновление UI для авторизованного пользователя
            function updateUIForLoggedInUser(userData) {
                // Активируем поле ввода и кнопки
                messageInput.disabled = false;
                messageInput.placeholder = "Опишите свой сон...";
                sendBtn.disabled = false;
                voiceBtn.disabled = false;
                
                // Обновляем иконку пользователя
                userIconSymbol.style.display = 'none';
                userInitials.style.display = 'block';
                userInitials.textContent = getInitials(userData.name);
                
                // Обновляем выпадающее меню
                phoneLoginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
            }
            
            // Обновление UI для гостя
            function updateUIForGuest() {
                // Деактивируем поле ввода и кнопки
                messageInput.disabled = true;
                messageInput.placeholder = "Войдите, чтобы отправить сообщение";
                sendBtn.disabled = true;
                voiceBtn.disabled = true;
                
                // Обновляем иконку пользователя
                userIconSymbol.style.display = 'block';
                userInitials.style.display = 'none';
                
                // Обновляем выпадающее меню
                phoneLoginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
            }
            
            // Получение инициалов из имени
            function getInitials(name) {
                return name.split(' ').map(word => word[0]).join('').toUpperCase();
            }
            
            // Управление модальными окнами
            function openModal(modal) {
                modal.classList.add('active');
            }
            
            function closeModal(modal) {
                modal.classList.remove('active');
            }
            
            function closeAllModals() {
                closeModal(phoneLoginModal);
                closeModal(paymentModal);
            }
            
            // Обработчики модальных окон
            phoneLoginBtn.addEventListener('click', () => openModal(phoneLoginModal));
            paymentBtn.addEventListener('click', () => openModal(paymentModal));
            
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    closeModal(modal);
                });
            });
            
            // Закрытие модальных окон при клике вне их области
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    closeAllModals();
                }
            });
            
            // Обработка формы входа по телефону
            document.getElementById('phoneLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userName = document.getElementById('userName').value.trim();
                const userPhone = document.getElementById('userPhone').value.trim();
                
                if (!userName || !userPhone) {
                    alert('Пожалуйста, заполните все поля');
                    return;
                }
                
                // Сохраняем данные пользователя
                const userData = {
                    name: userName,
                    phone: userPhone,
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem('userData', JSON.stringify(userData));
                
                // Обновляем UI
                updateUIForLoggedInUser(userData);
                
                // Закрываем модальное окно
                closeModal(phoneLoginModal);
                
                // Очищаем форму
                document.getElementById('phoneLoginForm').reset();
                
                // Добавляем приветственное сообщение
                addMessage(`Добро пожаловать, ${userName}! Теперь вы можете описывать свои сны и получать толкования.`, 'bot');
            });
            
            // Обработка выхода
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('userData');
                checkAuth();
                addMessage('Вы вышли из аккаунта. Для отправки сообщений войдите снова.', 'bot');
            });
            
            // Обработка выбора плана оплаты
            document.querySelectorAll('.plan-card .form-button').forEach(button => {
                button.addEventListener('click', function() {
                    const plan = this.getAttribute('data-plan');
                    processPayment(plan);
                });
            });
            
            // Функция обработки оплаты
            function processPayment(plan) {
                // В реальном приложении здесь будет запрос к серверу для создания платежа
                // Для демонстрации используем Robokassa
                const merchant_login = "demo";
                const password_1 = "password_1";
                const invid = Math.floor(Math.random() * 1000);
                const description = `Тариф "${plan === 'basic' ? 'Базовый' : 'Премиум'}" для ИИ Сонник`;
                const sum = plan === 'basic' ? "299" : "799";
                const signature_value = md5(`${merchant_login}:${sum}:${invid}:${password_1}`);
                
                // Создаем форму для отправки в Robokassa
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://auth.robokassa.ru/Merchant/Index.aspx';
                
                const fields = {
                    'MerchantLogin': merchant_login,
                    'OutSum': sum,
                    'InvId': invid,
                    'Description': description,
                    'SignatureValue': signature_value,
                    'IsTest': 1 // Тестовый режим
                };
                
                for (const key in fields) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    form.appendChild(input);
                }
                
                document.body.appendChild(form);
                form.submit();
            }
            
            // Простая реализация md5 для демонстрации
            function md5(input) {
                // В реальном приложении используйте надежную библиотеку md5
                // Это упрощенная версия для демонстрации
                return 'demo_signature_' + input.length;
            }
            
            // Загрузка черновика из localStorage
            const savedDraft = localStorage.getItem('dreamDraft');
            if (savedDraft) {
                messageInput.value = savedDraft;
            }
            
            // Сохранение черновика при вводе
            messageInput.addEventListener('input', function() {
                localStorage.setItem('dreamDraft', messageInput.value);
            });
            
            // Автоматическое увеличение высоты текстового поля
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Отправка сообщения
            async function sendMessage() {
                // Проверяем авторизацию
                if (!checkAuth()) {
                    openModal(phoneLoginModal);
                    return;
                }
                
                const message = messageInput.value.trim();
                if (message === '') return;
                
                // Добавление сообщения пользователя
                addMessage(message, 'user');
                
                // Очистка поля ввода и localStorage
                messageInput.value = '';
                localStorage.removeItem('dreamDraft');
                messageInput.style.height = 'auto';
                
                // Показать индикатор загрузки
                showLoadingIndicator();
                
                try {
                    // Получение ответа от AI модели
                    const botResponse = await getAIResponse(message);
                    removeLoadingIndicator();
                    addMessage(botResponse, 'bot');
                } catch (error) {
                    removeLoadingIndicator();
                    addMessage('Извините, произошла ошибка при обработке вашего запроса. Пожалуйста, попробуйте еще раз.', 'bot');
                    console.error('Ошибка:', error);
                }
            }
            
            // Добавление сообщения в чат
            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = getCurrentTime();
                
                // Добавляем кнопку озвучивания для сообщений бота
                if (sender === 'bot') {
                    const ttsBtn = document.createElement('button');
                    ttsBtn.className = 'tts-btn';
                    ttsBtn.setAttribute('aria-label', 'Озвучить сообщение');
                    ttsBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    ttsBtn.addEventListener('click', function() {
                        // В будущем здесь будет синтез речи
                        console.log('Озвучивание сообщения:', text);
                        // Временная заглушка - выделение кнопки
                        ttsBtn.style.color = 'var(--accent)';
                        setTimeout(() => {
                            ttsBtn.style.color = '';
                        }, 1000);
                    });
                    bubbleDiv.appendChild(ttsBtn);
                }
                
                bubbleDiv.innerHTML += text;
                bubbleDiv.appendChild(timeDiv);
                
                messageDiv.appendChild(bubbleDiv);
                chatMessages.appendChild(messageDiv);
                
                // Прокрутка к последнему сообщению
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Получение ответа от AI модели
            async function getAIResponse(userMessage) {
                // В реальном приложении замените на ваш API ключ
                const apiKey = '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';
                
                if (apiKey === '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') {
                    // Демо-режим, если API ключ не установлен
                    return generateDemoResponse(userMessage);
                }
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'ИИ Сонник'
                    },
                    body: JSON.stringify({
                        "model": "deepseek/deepseek-chat-v3-0324",
                        "messages": [
                            {
                                "role": "system",
                                "content": "Ты - опытный толкователь снов. Твоя задача - анализировать сны, которые описывают пользователи, и давать им психологическую интерпретацию. Будь внимательным к деталям и давай развернутые, но понятные объяснения."
                            },
                            {
                                "role": "user",
                                "content": userMessage
                            }
                        ]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Ошибка API: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            // Демо-ответы, если API ключ не установлен
            function generateDemoResponse(userMessage) {
                const responses = [
                    "Интересный сон! На основе анализа тысяч сновидений, могу сказать, что такой сон часто связан с эмоциональным состоянием. Возможно, вы переживаете о чем-то или испытываете внутреннее напряжение.",
                    "Толкование вашего сна указывает на внутренние переживания или нерешенные вопросы. Это может быть отражением вашего подсознания, которое пытается обработать дневные впечатления.",
                    "Согласно сонникам, подобные сны часто связаны с поиском себя или своего места в жизни. Возможно, вам стоит обратить внимание на текущие цели и приоритеты.",
                    "Ваш сон может отражать скрытые желания или страхи, которые требуют внимания. Попробуйте проанализировать, какие эмоции вы испытывали во сне - это может быть ключом к пониманию.",
                    "Интерпретация такого сна обычно связана с переменами, которые происходят или скоро произойдут в вашей жизни. Будьте открыты новым возможностям.",
                    "Этот сон может быть отражением вашего творческого потенциала или нереализованных идей. Возможно, пришло время выразить себя в каком-то новом качестве."
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            // Показать индикатор загрузки
            function showLoadingIndicator() {
                const skeletonDiv = document.createElement('div');
                skeletonDiv.className = 'message bot-message skeleton';
                skeletonDiv.id = 'loadingIndicator';
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'skeleton-avatar';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'skeleton-content';
                
                const line1 = document.createElement('div');
                line1.className = 'skeleton-line short';
                
                const line2 = document.createElement('div');
                line2.className = 'skeleton-line medium';
                
                const line3 = document.createElement('div');
                line3.className = 'skeleton-line';
                
                contentDiv.appendChild(line1);
                contentDiv.appendChild(line2);
                contentDiv.appendChild(line3);
                
                skeletonDiv.appendChild(avatarDiv);
                skeletonDiv.appendChild(contentDiv);
                
                chatMessages.appendChild(skeletonDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Удалить индикатор загрузки
            function removeLoadingIndicator() {
                const indicator = document.getElementById('loadingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            // Получить текущее время
            function getCurrentTime() {
                const now = new Date();
                return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // Обработчики событий
            sendBtn.addEventListener('click', sendMessage);
            
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Имитация голосового ввода
            let isRecording = false;
            voiceBtn.addEventListener('click', function() {
                // Проверяем авторизацию
                if (!checkAuth()) {
                    openModal(phoneLoginModal);
                    return;
                }
                
                isRecording = !isRecording;
                
                if (isRecording) {
                    voiceBtn.classList.add('pulse');
                    voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    messageInput.placeholder = "Говорите...";
                    
                    // Имитация распознавания речи через 3 секунды
                    setTimeout(() => {
                        if (isRecording) {
                            messageInput.value = "Приснилось, что я нахожусь в незнакомом месте, но чувствую себя как дома.";
                            voiceBtn.classList.remove('pulse');
                            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                            messageInput.placeholder = "Опишите свой сон...";
                            isRecording = false;
                        }
                    }, 3000);
                } else {
                    voiceBtn.classList.remove('pulse');
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    messageInput.placeholder = "Опишите свой сон...";
                }
            });
            
            // Добавление приветственного сообщения
            setTimeout(() => {
                addMessage("Привет! Я ИИ-сонник. Опишите свой сон, и я помогу вам понять его значение. Для начала работы войдите в аккаунт.", 'bot');
            }, 500);
            
            // Проверяем авторизацию при загрузке
            checkAuth();
            
            // Создание звёзд
            createStars();
        });
    </script>
</body>
</html>
